<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script>
        // config.js ë¡œë“œ í›„ ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ì¶”ê°€
        (function() {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            // ncpClientId ëŒ€ì‹  ncpKeyId ì‚¬ìš© (NAVER ë¬¸ì„œ ê¸°ì¤€)
            // í´ëŸ¬ìŠ¤í„°ë§ ì‚¬ìš©ì„ ìœ„í•´ submodules=clustering í¬í•¨
            script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NAVER_MAP_CLIENT_ID}&submodules=clustering`;
            document.head.appendChild(script);
        })();
    </script>
</head>
<body>
    <div class="topnav">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³ ê²€ìƒ‰...">
        </div>
        <button class="register-btn" onclick="goToLogin()">ë‘ì«€ì¿  íŒë§¤ì¹´í˜ ë“±ë¡</button>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let map;
        let markers = [];
        let infoWindows = [];
        let stores = [];
        let markerCluster = null;

        // ì¤Œì´ ì´ ê°’ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ í´ëŸ¬ìŠ¤í„°(í° ì›) í‘œì‹œ
        // (ì›í•˜ì‹œë©´ â€œí™•ëŒ€í• ìˆ˜ë¡ í° ì›â€ ë™ì‘ìœ¼ë¡œ ë°˜ëŒ€ë¡œë„ ë°”ê¿”ë“œë¦´ê²Œìš”)
        const CLUSTER_MAX_ZOOM = 13;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.onload = function() {
            // ë„¤ì´ë²„ ì§€ë„ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
                console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                alert('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤ì´ë²„ ì§€ë„ API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì™„ë£Œ');
            initMap();
        };

        // ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // ì§€ë„ ìƒì„±
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
                zoom: 12,
                minZoom: 8,
                maxZoom: 18,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                }
            });

            setupClusterZoomToggle();
            setupMapClickToCloseInfoWindows();
            loadStores();
            setupSearch();
        }

        // ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ ëª¨ë“  ì¹´ë“œ(ì •ë³´ì°½) ë‹«ê¸°
        function setupMapClickToCloseInfoWindows() {
            naver.maps.Event.addListener(map, 'click', function() {
                infoWindows.forEach(iw => iw.close());
            });
        }

        function setupClusterZoomToggle() {
            naver.maps.Event.addListener(map, 'zoom_changed', function() {
                if (!markerCluster) return;
                const z = map.getZoom();
                if (z <= CLUSTER_MAX_ZOOM) {
                    markerCluster.setMap(map);
                } else {
                    markerCluster.setMap(null);
                }
            });
        }

        // ë§¤ì¥ ë°ì´í„° ë¡œë“œ
        async function loadStores() {
            try {
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .eq('checked', 'true');

                if (error) throw error;

                stores = data || [];
                displayMarkers(stores);
            } catch (error) {
                console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë§ˆì»¤ í‘œì‹œ
        function displayMarkers(storeList) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            infoWindows.forEach(infoWindow => infoWindow.close());
            infoWindows = [];
            if (markerCluster) {
                markerCluster.setMap(null);
                markerCluster = null;
            }

            storeList.forEach(store => {
                if (!store.location) return;

                // location íŒŒì‹±
                let lat, lng;
                if (typeof store.location === 'string') {
                    const coords = store.location.split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                } else if (store.location.coordinates) {
                    lng = store.location.coordinates[0];
                    lat = store.location.coordinates[1];
                } else {
                    return;
                }

                const number = parseInt(store.number) || 0;
                const position = new naver.maps.LatLng(lat, lng);

                // ë°°ê²½ìƒ‰ ê²°ì •
                let bgColor, textColor;
                if (number === 0) {
                    bgColor = '#000000';
                    textColor = '#ffffff';
                } else if (number < 30) {
                    bgColor = '#FFD700';
                    textColor = '#000000';
                } else {
                    bgColor = '#a5d184';
                    textColor = '#ffffff';
                }

                // ì»¤ìŠ¤í…€ ë§ˆì»¤ HTML
                const markerContent = `
                    <div style="position: relative; width: 40px; height: 50px; cursor: pointer;">
                        <img src="doozonku.png" style="width: 40px; height: 40px; display: block;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><circle cx=%2220%22 cy=%2220%22 r=%2218%22 fill=%22%23FF6B6B%22/><text x=%2220%22 y=%2225%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22>ğŸª</text></svg>'">
                        <div style="
                            position: absolute;
                            top: 8px;
                            left: 50%;
                            transform: translateX(-50%);
                            background-color: ${bgColor};
                            color: ${textColor};
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: bold;
                            border: 2px solid white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        ">${number}</div>
                    </div>
                `;

                // ë„¤ì´ë²„ ë§ˆì»¤ ìƒì„±
                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        content: markerContent,
                        size: new naver.maps.Size(40, 50),
                        anchor: new naver.maps.Point(20, 50)
                    }
                });
                // í´ëŸ¬ìŠ¤í„° í•©ì‚°ìš© ê°’ ì €ì¥
                marker.set('inventory', number);

                // ì •ë³´ì°½ ë‚´ìš©
                const infoWindowContent = `
                    <div style="padding: 15px; min-width: 250px; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">${store.subject || 'ë§¤ì¥ëª… ì—†ìŒ'}</h3>
                        ${store.img ? `<img src="${store.img}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">` : ''}
                        <p style="margin: 5px 0; font-size: 14px; color: #666;">${store.plaintext || ''}</p>
                        <p style="margin: 5px 0; font-weight: bold; font-size: 14px; color: ${number === 0 ? '#e74c3c' : number < 30 ? '#f39c12' : '#27ae60'};">ì¬ê³ : ${number}ê°œ</p>
                        <p style="margin: 5px 0; font-size: 13px; color: #999;">${store.address || ''}</p>
                        ${store.url ? `<a href="${store.url}" target="_blank" style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #4285f4; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">ìì„¸íˆ ë³´ê¸° â†’</a>` : ''}
                    </div>
                `;

                // ì •ë³´ì°½ ìƒì„±
                const infoWindow = new naver.maps.InfoWindow({
                    content: infoWindowContent,
                    borderWidth: 0,
                    backgroundColor: 'white',
                    borderColor: '#ddd',
                    borderRadius: '10px',
                    anchorSize: new naver.maps.Size(10, 10),
                    anchorSkew: true,
                    pixelOffset: new naver.maps.Point(0, -10)
                });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                naver.maps.Event.addListener(marker, 'click', function() {
                    // ë‹¤ë¥¸ ì •ë³´ì°½ ë‹«ê¸°
                    infoWindows.forEach(iw => iw.close());

                    // ì¹´ë“œ(ì •ë³´ì°½)ë¥¼ ë³´ê¸° ì¢‹ê²Œ ë°°ì¹˜í•˜ê¸° ìœ„í•´
                    // - ê°€ë¡œ: ê±°ì˜ ì¤‘ì•™
                    // - ì„¸ë¡œ: í™”ë©´ ì¤‘ê°„ë³´ë‹¤ ì•½ê°„ ì•„ë˜ìª½ì— ë§ˆì»¤ê°€ ì˜¤ë„ë¡ ì‚´ì§ ìœ„ë¡œ ì˜¬ë¦° ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
                    moveCenterForInfoWindow(marker.getPosition());

                    // í˜„ì¬ ì •ë³´ì°½ ì—´ê¸°
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                infoWindows.push(infoWindow);
            });

            // í´ëŸ¬ìŠ¤í„°(í° ì›) ìƒì„±: â€œê·¸ ì§€ì—­ì˜ ìˆ«ì í•©(ì¬ê³  í•©ê³„)â€ í‘œì‹œ
            // - ì¤Œì´ ì‘ì„ ë•Œ(ë©€ë¦¬ ë³¼ ë•Œ) í´ëŸ¬ìŠ¤í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.
            markerCluster = new MarkerClustering({
                minClusterSize: 2,
                maxZoom: CLUSTER_MAX_ZOOM,
                map: map,
                markers: markers,
                disableClickZoom: false,
                gridSize: 120,
                // í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ì€ HTMLë¡œ ì»¤ìŠ¤í…€ (í° ì› + í•©ê³„ ìˆ«ì)
                icons: [createSumClusterIcon('#ffffff', '#111111')],
                indexGenerator: [10, 100, 200, 500, 1000],
                stylingFunction: function(clusterMarker, count) {
                    // countëŠ” â€œë§ˆì»¤ ê°œìˆ˜â€ë¼ì„œ, ìš°ë¦¬ëŠ” ì•„ë˜ calculatorì—ì„œ í•©ê³„ë¥¼ ë§Œë“¤ì–´ contentì— ë„£ìŠµë‹ˆë‹¤.
                    // ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ìŠ¤íƒ€ì¼ì´ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©.
                    clusterMarker.getElement().style.cursor = 'pointer';
                },
                calculator: function(markerArray) {
                    // markerArrayëŠ” í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ëœ ë§ˆì»¤ ë°°ì—´
                    const sum = markerArray.reduce((acc, m) => acc + (parseInt(m.get('inventory')) || 0), 0);
                    // ì•„ì´ì½˜ HTML ë‚´ë¶€ í…ìŠ¤íŠ¸ë¥¼ sumìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°í•˜ê¸° ìœ„í•´,
                    // MarkerClusteringì˜ calculator ë°˜í™˜ê°’ì„ index + text ë‘˜ ë‹¤ í™œìš©í•©ë‹ˆë‹¤.
                    // (indexëŠ” icons ë°°ì—´ ì¸ë±ìŠ¤ ì„ íƒìš©)
                    return {
                        text: String(sum),
                        index: 0
                    };
                }
            });

            // ì´ˆê¸° ì¤Œì— ë”°ë¥¸ í‘œì‹œ í† ê¸€
            if (map.getZoom() > CLUSTER_MAX_ZOOM) {
                markerCluster.setMap(null);
            }
        }

        // ë§ˆì»¤ë¥¼ ê°€ë¡œ ë°©í–¥ìœ¼ë¡œë§Œ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì§€ë„ ì¤‘ì‹¬ì„ ì¡°ì •
        function moveCenterForInfoWindow(latlng) {
            // ì‚¬ìš©ìê°€ ìš”ì²­í•œ ëŒ€ë¡œ, ì„¸ë¡œ ìœ„ì¹˜ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ 
            // ë§ˆì»¤ ì¢Œí‘œë¥¼ ê·¸ëŒ€ë¡œ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
            map.panTo(latlng);
        }

        function createSumClusterIcon(bgColor, textColor) {
            // MarkerClusteringì€ â€œtextâ€ê°€ ë“¤ì–´ê°ˆ ìš”ì†Œë¥¼ `.cluster-text`ë¡œ ì°¾ìŠµë‹ˆë‹¤.
            // ê·¸ë˜ì„œ content ë‚´ë¶€ì— í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤.
            return {
                content: `
                    <div style="
                        width: 64px;
                        height: 64px;
                        border-radius: 50%;
                        background: ${bgColor};
                        border: 4px solid rgba(0,0,0,0.15);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 800;
                        font-size: 18px;
                        color: ${textColor};
                        user-select: none;
                    ">
                        <span class="cluster-text">0</span>
                    </div>
                `,
                size: new naver.maps.Size(64, 64),
                anchor: new naver.maps.Point(32, 32)
            };
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    displayMarkers(stores);
                } else {
                    const filtered = stores.filter(store => 
                        (store.subject && store.subject.toLowerCase().includes(searchTerm)) ||
                        (store.address && store.address.toLowerCase().includes(searchTerm)) ||
                        (store.plaintext && store.plaintext.toLowerCase().includes(searchTerm))
                    );
                    
                    displayMarkers(filtered);
                    
                    // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì§€ë„ ì´ë™
                    if (filtered.length > 0 && filtered[0].location) {
                        let lat, lng;
                        if (typeof filtered[0].location === 'string') {
                            const coords = filtered[0].location.split(',').map(c => c.trim());
                            lat = parseFloat(coords[0]);
                            lng = parseFloat(coords[1]);
                        } else if (filtered[0].location.coordinates) {
                            lng = filtered[0].location.coordinates[0];
                            lat = filtered[0].location.coordinates[1];
                        }
                        
                        if (lat && lng) {
                            map.setCenter(new naver.maps.LatLng(lat, lng));
                            map.setZoom(15);
                        }
                    }
                }
            });
        }

        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        function goToLogin() {
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
