<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="topnav">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³ ê²€ìƒ‰...">
        </div>
        <button class="register-btn" onclick="goToLogin()">ë‘ì«€ì¿  íŒë§¤ì¹´í˜ ë“±ë¡</button>
    </div>
    
    <div id="map"></div>

    <script src="config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let map;
        let markers = [];
        let infoWindows = [];
        let stores = [];
        let naverMapLoaded = false;

        // ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
        function loadNaverMapScript() {
            return new Promise((resolve, reject) => {
                if (naverMapLoaded) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${NAVER_MAP_CLIENT_ID}`;
                script.onload = () => {
                    naverMapLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                };
                document.head.appendChild(script);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.onload = async function() {
            try {
                await loadNaverMapScript();
                initMap();
            } catch (error) {
                console.error('ì§€ë„ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤ì´ë²„ ì§€ë„ API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        };

        // ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // ì§€ë„ ìƒì„±
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
                zoom: 12,
                minZoom: 8,
                maxZoom: 18,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                }
            });

            loadStores();
            setupSearch();
        }

        // ë§¤ì¥ ë°ì´í„° ë¡œë“œ
        async function loadStores() {
            try {
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .eq('checked', 'true');

                if (error) throw error;

                stores = data || [];
                displayMarkers(stores);
            } catch (error) {
                console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë§ˆì»¤ í‘œì‹œ
        function displayMarkers(storeList) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            infoWindows.forEach(infoWindow => infoWindow.close());
            infoWindows = [];

            storeList.forEach(store => {
                if (!store.location) return;

                // location íŒŒì‹±
                let lat, lng;
                if (typeof store.location === 'string') {
                    const coords = store.location.split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                } else if (store.location.coordinates) {
                    lng = store.location.coordinates[0];
                    lat = store.location.coordinates[1];
                } else {
                    return;
                }

                const number = parseInt(store.number) || 0;
                const position = new naver.maps.LatLng(lat, lng);

                // ë°°ê²½ìƒ‰ ê²°ì •
                let bgColor, textColor;
                if (number === 0) {
                    bgColor = '#000000';
                    textColor = '#ffffff';
                } else if (number < 30) {
                    bgColor = '#FFD700';
                    textColor = '#000000';
                } else {
                    bgColor = '#a5d184';
                    textColor = '#ffffff';
                }

                // ì»¤ìŠ¤í…€ ë§ˆì»¤ HTML
                const markerContent = `
                    <div style="position: relative; width: 40px; height: 50px; cursor: pointer;">
                        <img src="doozonku.png" style="width: 40px; height: 40px; display: block;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><circle cx=%2220%22 cy=%2220%22 r=%2218%22 fill=%22%23FF6B6B%22/><text x=%2220%22 y=%2225%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22>ğŸª</text></svg>'">
                        <div style="
                            position: absolute;
                            top: 8px;
                            left: 50%;
                            transform: translateX(-50%);
                            background-color: ${bgColor};
                            color: ${textColor};
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: bold;
                            border: 2px solid white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        ">${number}</div>
                    </div>
                `;

                // ë„¤ì´ë²„ ë§ˆì»¤ ìƒì„±
                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        content: markerContent,
                        size: new naver.maps.Size(40, 50),
                        anchor: new naver.maps.Point(20, 50)
                    }
                });

                // ì •ë³´ì°½ ë‚´ìš©
                const infoWindowContent = `
                    <div style="padding: 15px; min-width: 250px; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">${store.subject || 'ë§¤ì¥ëª… ì—†ìŒ'}</h3>
                        ${store.img ? `<img src="${store.img}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">` : ''}
                        <p style="margin: 5px 0; font-size: 14px; color: #666;">${store.plaintext || ''}</p>
                        <p style="margin: 5px 0; font-weight: bold; font-size: 14px; color: ${number === 0 ? '#e74c3c' : number < 30 ? '#f39c12' : '#27ae60'};">ì¬ê³ : ${number}ê°œ</p>
                        <p style="margin: 5px 0; font-size: 13px; color: #999;">${store.address || ''}</p>
                        ${store.url ? `<a href="${store.url}" target="_blank" style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #4285f4; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">ìì„¸íˆ ë³´ê¸° â†’</a>` : ''}
                    </div>
                `;

                // ì •ë³´ì°½ ìƒì„±
                const infoWindow = new naver.maps.InfoWindow({
                    content: infoWindowContent,
                    borderWidth: 0,
                    backgroundColor: 'white',
                    borderColor: '#ddd',
                    borderRadius: '10px',
                    anchorSize: new naver.maps.Size(10, 10),
                    anchorSkew: true,
                    pixelOffset: new naver.maps.Point(0, -10)
                });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                naver.maps.Event.addListener(marker, 'click', function() {
                    // ë‹¤ë¥¸ ì •ë³´ì°½ ë‹«ê¸°
                    infoWindows.forEach(iw => iw.close());
                    // í˜„ì¬ ì •ë³´ì°½ ì—´ê¸°
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                infoWindows.push(infoWindow);
            });
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    displayMarkers(stores);
                } else {
                    const filtered = stores.filter(store => 
                        (store.subject && store.subject.toLowerCase().includes(searchTerm)) ||
                        (store.address && store.address.toLowerCase().includes(searchTerm)) ||
                        (store.plaintext && store.plaintext.toLowerCase().includes(searchTerm))
                    );
                    
                    displayMarkers(filtered);
                    
                    // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì§€ë„ ì´ë™
                    if (filtered.length > 0 && filtered[0].location) {
                        let lat, lng;
                        if (typeof filtered[0].location === 'string') {
                            const coords = filtered[0].location.split(',').map(c => c.trim());
                            lat = parseFloat(coords[0]);
                            lng = parseFloat(coords[1]);
                        } else if (filtered[0].location.coordinates) {
                            lng = filtered[0].location.coordinates[0];
                            lat = filtered[0].location.coordinates[1];
                        }
                        
                        if (lat && lng) {
                            map.setCenter(new naver.maps.LatLng(lat, lng));
                            map.setZoom(15);
                        }
                    }
                }
            });
        }

        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        function goToLogin() {
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
