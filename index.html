<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script>
        // config.js ë¡œë“œ í›„ ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ì¶”ê°€
        (function() {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            // ncpClientId ëŒ€ì‹  ncpKeyId ì‚¬ìš© (NAVER ë¬¸ì„œ ê¸°ì¤€)
            // í´ëŸ¬ìŠ¤í„°ë§ ì‚¬ìš©ì„ ìœ„í•´ submodules=clustering í¬í•¨
            script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${NAVER_MAP_CLIENT_ID}&submodules=clustering`;
            document.head.appendChild(script);
        })();
    </script>
</head>
<body>
    <div class="topnav">
        <div class="logo-container">
            <img src="logo.png" alt="ë‘ì«€ì¿ " class="logo">
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íŒŒëŠ”ê³³ ê²€ìƒ‰...">
            <div id="searchResults" class="search-results hidden"></div>
        </div>
        <button class="register-btn" onclick="goToLogin()">
            <span class="register-btn-icon">ğŸ§‘â€ğŸ³</span>
            <span>ì‚¬ì¥ë‹˜</span>
        </button>
    </div>
    
    <div id="map"></div>
    
    <button id="myLocationBtn" class="floating-btn" onclick="moveToMyLocation()" title="ë‚´ ì£¼ë³€">
        <span class="floating-btn-icon">ğŸ“</span>
        <span class="floating-btn-text">ì£¼ë³€</span>
    </button>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let map;
        let markers = [];
        let infoWindows = [];
        let stores = [];
        let markerCluster = null;
        let currentInfoWindow = null;
        let storeMarkerMap = {};
        let storeInfoWindowMap = {};

        // ì¤Œì´ ì´ ê°’ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ìœ¼ë©´ í´ëŸ¬ìŠ¤í„°(í° ì›) í‘œì‹œ
        // (ì›í•˜ì‹œë©´ â€œí™•ëŒ€í• ìˆ˜ë¡ í° ì›â€ ë™ì‘ìœ¼ë¡œ ë°˜ëŒ€ë¡œë„ ë°”ê¿”ë“œë¦´ê²Œìš”)
        const CLUSTER_MAX_ZOOM = 13;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.onload = function() {
            // ë„¤ì´ë²„ ì§€ë„ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
                console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                alert('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤ì´ë²„ ì§€ë„ API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì™„ë£Œ');
            initMap();
        };

        // ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // ì§€ë„ ìƒì„±
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
                zoom: 12,
                minZoom: 8,
                maxZoom: 18,
                zoomControl: false
            });

            setupClusterZoomToggle();
            setupMapClickToCloseInfoWindows();
            loadStores();
            setupSearch();
        }

        // ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ ëª¨ë“  ì¹´ë“œ(ì •ë³´ì°½) ë‹«ê¸°
        function setupMapClickToCloseInfoWindows() {
            naver.maps.Event.addListener(map, 'click', function() {
                infoWindows.forEach(iw => iw.close());
            });
        }

        function setupClusterZoomToggle() {
            naver.maps.Event.addListener(map, 'zoom_changed', function() {
                if (!markerCluster) return;
                const z = map.getZoom();
                if (z <= CLUSTER_MAX_ZOOM) {
                    markerCluster.setMap(map);
                } else {
                    markerCluster.setMap(null);
                }
            });
        }

        // ë§¤ì¥ ë°ì´í„° ë¡œë“œ
        async function loadStores() {
            try {
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .eq('checked', 'true');

                if (error) throw error;

                stores = data || [];
                displayMarkers(stores);
            } catch (error) {
                console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë§ˆì»¤ í‘œì‹œ
        function displayMarkers(storeList) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            infoWindows.forEach(infoWindow => infoWindow.close());
            infoWindows = [];
            if (markerCluster) {
                markerCluster.setMap(null);
                markerCluster = null;
            }
            storeMarkerMap = {};
            storeInfoWindowMap = {};

            storeList.forEach(store => {
                if (!store.location) return;

                // location íŒŒì‹±
                let lat, lng;
                if (typeof store.location === 'string') {
                    const coords = store.location.split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                } else if (store.location.coordinates) {
                    lng = store.location.coordinates[0];
                    lat = store.location.coordinates[1];
                } else {
                    return;
                }

                const number = parseInt(store.number) || 0;
                const position = new naver.maps.LatLng(lat, lng);

                // ë°°ê²½ìƒ‰ ê²°ì •
                let bgColor, textColor;
                if (number === 0) {
                    bgColor = '#000000';
                    textColor = '#ffffff';
                } else if (number < 30) {
                    bgColor = '#FFD700';
                    textColor = '#000000';
                } else {
                    bgColor = '#21b570';
                    textColor = '#ffffff';
                }

                // ì»¤ìŠ¤í…€ ë§ˆì»¤ HTML
                const markerContent = `
                    <div style="position: relative; width: 56px; height: 66px; cursor: pointer;">
                        <img src="duzonkus.png" style="width: 56px; height: 56px; display: block;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22><circle cx=%2228%22 cy=%2228%22 r=%2226%22 fill=%22%23FF6B6B%22/><text x=%2228%22 y=%2235%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2224%22>ğŸª</text></svg>'">
                        <div style="
                            position: absolute;
                            top: 4px;
                            right: 0;
                            transform: translateX(48%);
                            background-color: ${bgColor};
                            color: ${textColor};
                            border-radius: 9px;
                            min-width: 28px;
                            height: 24px;
                            padding: 0 11px;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 13px;
                            font-weight: bold;
                            border: 1px solid white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            box-sizing: border-box;
                        ">${number}</div>
                    </div>
                `;

                // ë„¤ì´ë²„ ë§ˆì»¤ ìƒì„±
                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        content: markerContent,
                        size: new naver.maps.Size(56, 66),
                        anchor: new naver.maps.Point(28, 66)
                    }
                });
                // í´ëŸ¬ìŠ¤í„° í•©ì‚°ìš© ê°’ ì €ì¥
                marker.set('inventory', number);

                // ì¬ê³  ìƒíƒœ í…ìŠ¤íŠ¸ ê²°ì •
                let statusText, statusColor, statusBgColor;
                if (number === 0) {
                    statusText = 'í’ˆì ˆ';
                    statusColor = '#e74c3c';
                    statusBgColor = '#fee';
                } else if (number < 30) {
                    statusText = 'í’ˆì ˆ ì„ë°•';
                    statusColor = '#f39c12';
                    statusBgColor = '#fff4e6';
                } else {
                    statusText = 'ì—¬ìœ ';
                    statusColor = '#27ae60';
                    statusBgColor = '#e8f5e9';
                }

                // ì—…ë°ì´íŠ¸ ì‹œê°„ ê³„ì‚°
                function getTimeAgo(dateString) {
                    if (!dateString) return '';
                    const now = new Date();
                    const updated = new Date(dateString);
                    const diffMs = now - updated;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
                    if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
                    if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
                    if (diffDays < 7) return `${diffDays}ì¼ ì „`;
                    return updated.toLocaleDateString('ko-KR');
                }

                const timeAgo = getTimeAgo(store.updated_at || store.created_at);

                // ì„¤ëª… í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë”°ì˜´í‘œ ì¶”ê°€ ë° ëì— "ê³¼ " ë˜ëŠ” "ë¡œ " ì¶”ê°€)
                let plaintext = store.plaintext || '';
                if (plaintext) {
                    // ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
                    if (!plaintext.startsWith('"')) {
                        plaintext = '"' + plaintext;
                    }
                    if (!plaintext.endsWith('"') && !plaintext.match(/[ê³¼ë¡œ]$/)) {
                        const lastChar = plaintext[plaintext.length - 1];
                        if (lastChar !== 'ê³¼' && lastChar !== 'ë¡œ') {
                            plaintext += 'ê³¼ ';
                        }
                        plaintext += '"';
                    } else if (!plaintext.endsWith('"')) {
                        plaintext += '"';
                    }
                }

                // ë„¤ì´ë²„ ì§€ë„ URL ìƒì„±
                let naverMapUrl = '';
                if (store.location) {
                    let lat, lng;
                    if (typeof store.location === 'string') {
                        const coords = store.location.split(',').map(c => c.trim());
                        lat = parseFloat(coords[0]);
                        lng = parseFloat(coords[1]);
                    } else if (store.location.coordinates) {
                        lng = store.location.coordinates[0];
                        lat = store.location.coordinates[1];
                    }
                    if (lat && lng) {
                        naverMapUrl = `https://map.naver.com/v5/search/${encodeURIComponent(store.address || store.subject || '')}/place/${lng},${lat}`;
                    }
                }

                // ì •ë³´ì°½ ë‚´ìš©
                const infoWindowContent = `
                    <div style="padding: 0; min-width: 250px; max-width: 300px; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 8px 20px rgba(0,0,0,0.12);">
                        <div style="padding: 20px; border-radius: 12px; overflow: hidden; background: white;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px;">
                                <h3 style="margin: 0; font-size: 18px; color: #3b2d23; font-weight: 600;">${store.subject || 'ë§¤ì¥ëª… ì—†ìŒ'}</h3>
                                <button class="doozonku-info-close" onclick="window.doozonkuCloseInfoWindow && window.doozonkuCloseInfoWindow(event)" style="border: none; background: transparent; cursor: pointer; font-size: 16px; color: #999; padding: 4px; border-radius: 999px; line-height: 1;">
                                    âœ•
                                </button>
                            </div>
                            ${store.img ? `<img src="${store.img}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; display: block;">` : ''}
                            <div style="background: ${statusBgColor}; padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
                                    <span style="font-weight: bold; font-size: 15px; color: ${statusColor};">ì¬ê³ : ${number}ê°œ</span>
                                    <span style="padding: 4px 10px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">${statusText}</span>
                                </div>
                            </div>
                            ${timeAgo ? `<p style="margin: 0 0 10px 0; font-size: 12px; color: #999;">${timeAgo} ì—…ë°ì´íŠ¸</p>` : ''}
                            <p style="margin: 0 0 10px 0; font-size: 14px; color: #666; line-height: 1.5;">${plaintext}</p>
                            <p style="margin: 0 0 12px 0; font-size: 13px; color: #999;">${store.address || ''}</p>
                            ${naverMapUrl ? `<a href="${naverMapUrl}" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px 16px; background: #2ec95d; color: white; text-decoration: none; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center; box-sizing: border-box;"><img src="https://i.namu.wiki/i/S7V8Htt8LRUHYE5barta7QNNYklp8ZHZcYlMG4er6vD0XV1QsxWpkgb__Z7AJ0_-BzZsTdp3jJIERn81ttc_UQ.webp" style="width: 20px; height: 20px; border-radius: 4px; object-fit: contain;" alt="ë„¤ì´ë²„ ì§€ë„">ë„¤ì´ë²„ ì§€ë„ì—ì„œ ë³´ê¸° â†’</a>` : ''}
                        </div>
                    </div>
                `;

                // ì •ë³´ì°½ ìƒì„±
                const infoWindow = new naver.maps.InfoWindow({
                    content: infoWindowContent,
                    borderWidth: 0,
                    backgroundColor: 'transparent',
                    borderColor: 'transparent',
                    borderRadius: '12px',
                    anchorSize: new naver.maps.Size(10, 10),
                    anchorSkew: true,
                    pixelOffset: new naver.maps.Point(0, -10)
                });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                naver.maps.Event.addListener(marker, 'click', function() {
                    // ë‹¤ë¥¸ ì •ë³´ì°½ ë‹«ê¸°
                    infoWindows.forEach(iw => iw.close());

                    // ì¹´ë“œ(ì •ë³´ì°½)ë¥¼ ë³´ê¸° ì¢‹ê²Œ ë°°ì¹˜í•˜ê¸° ìœ„í•´
                    // - ê°€ë¡œ: ê±°ì˜ ì¤‘ì•™
                    // - ì„¸ë¡œ: í™”ë©´ ì¤‘ê°„ë³´ë‹¤ ì•½ê°„ ì•„ë˜ìª½ì— ë§ˆì»¤ê°€ ì˜¤ë„ë¡ ì‚´ì§ ìœ„ë¡œ ì˜¬ë¦° ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
                    moveCenterForInfoWindow(marker.getPosition());

                    // í˜„ì¬ ì •ë³´ì°½ ì—´ê¸°
                    currentInfoWindow = infoWindow;
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                infoWindows.push(infoWindow);
                if (store.id) {
                    storeMarkerMap[store.id] = marker;
                    storeInfoWindowMap[store.id] = infoWindow;
                }
            });

            // í´ëŸ¬ìŠ¤í„°(í° ì›) ìƒì„±: â€œê·¸ ì§€ì—­ì˜ ìˆ«ì í•©(ì¬ê³  í•©ê³„)â€ í‘œì‹œ
            // - ì¤Œì´ ì‘ì„ ë•Œ(ë©€ë¦¬ ë³¼ ë•Œ) í´ëŸ¬ìŠ¤í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.
            // ë„¤ì´ë²„ ì§€ë„ clusterer ì„œë¸Œëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•ˆì „í•˜ê²Œ ë¦¬í„´
            if (!naver.maps.MarkerClustering) {
                console.warn('MarkerClustering ì„œë¸Œëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„°ë§ì„ ìƒëµí•©ë‹ˆë‹¤.');
                return;
            }

            markerCluster = new naver.maps.MarkerClustering({
                minClusterSize: 2,
                maxZoom: CLUSTER_MAX_ZOOM,
                map: map,
                markers: markers,
                disableClickZoom: false,
                gridSize: 120,
                // í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ì€ HTMLë¡œ ì»¤ìŠ¤í…€ (í° ì› + í•©ê³„ ìˆ«ì)
                icons: [createSumClusterIcon('#ffffff', '#111111')],
                indexGenerator: [10, 100, 200, 500, 1000],
                stylingFunction: function(clusterMarker, count) {
                    // countëŠ” â€œë§ˆì»¤ ê°œìˆ˜â€ë¼ì„œ, ìš°ë¦¬ëŠ” ì•„ë˜ calculatorì—ì„œ í•©ê³„ë¥¼ ë§Œë“¤ì–´ contentì— ë„£ìŠµë‹ˆë‹¤.
                    // ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ìŠ¤íƒ€ì¼ì´ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©.
                    clusterMarker.getElement().style.cursor = 'pointer';
                },
                calculator: function(markerArray) {
                    // markerArrayëŠ” í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ëœ ë§ˆì»¤ ë°°ì—´
                    const sum = markerArray.reduce((acc, m) => acc + (parseInt(m.get('inventory')) || 0), 0);
                    // ì•„ì´ì½˜ HTML ë‚´ë¶€ í…ìŠ¤íŠ¸ë¥¼ sumìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°í•˜ê¸° ìœ„í•´,
                    // MarkerClusteringì˜ calculator ë°˜í™˜ê°’ì„ index + text ë‘˜ ë‹¤ í™œìš©í•©ë‹ˆë‹¤.
                    // (indexëŠ” icons ë°°ì—´ ì¸ë±ìŠ¤ ì„ íƒìš©)
                    return {
                        text: String(sum),
                        index: 0
                    };
                }
            });

            // ì´ˆê¸° ì¤Œì— ë”°ë¥¸ í‘œì‹œ í† ê¸€
            if (map.getZoom() > CLUSTER_MAX_ZOOM) {
                markerCluster.setMap(null);
            }
        }

        // ì „ì—­ì—ì„œ ë‹«ê¸° ë²„íŠ¼ì´ ì‚¬ìš©í•  í•¨ìˆ˜
        window.doozonkuCloseInfoWindow = function(e) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        };

        // ë§ˆì»¤ë¥¼ ê°€ë¡œëŠ” í™”ë©´ ì¤‘ì•™, ì„¸ë¡œëŠ” í™”ë©´ í•˜ë‹¨ì— ê°€ê¹ê²Œ ë°°ì¹˜
        function moveCenterForInfoWindow(latlng) {
            // í™”ë©´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const mapSize = map.getSize();
            const height = mapSize.height;
            
            // í™”ë©´ í•˜ë‹¨ 1/4 ì§€ì ì— ë§ˆì»¤ê°€ ì˜¤ë„ë¡ ì¤‘ì‹¬ì„ ì¡°ì •
            // ë§ˆì»¤ë¥¼ í™”ë©´ í•˜ë‹¨ì— ìœ„ì¹˜ì‹œí‚¤ë ¤ë©´ ì¤‘ì‹¬ì„ ë§ˆì»¤ë³´ë‹¤ ì•„ë˜(ë‚¨ìª½)ë¡œ ì´ë™
            // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í”½ì…€ë‹¹ ìœ„ë„ ì°¨ì´ê°€ ë‹¬ë¼ì§€ë¯€ë¡œ ì¤Œ ë ˆë²¨ ê³ ë ¤
            const z = map.getZoom();
            const bounds = map.getBounds();
            const sw = bounds.getSW();
            const ne = bounds.getNE();
            const latRange = ne.lat() - sw.lat(); // í™”ë©´ ì „ì²´ì˜ ìœ„ë„ ë²”ìœ„
            
            // í™”ë©´ í•˜ë‹¨ 1/4 ì§€ì  = í™”ë©´ ì „ì²´ ë†’ì´ì˜ 3/4ë§Œí¼ ì•„ë˜ë¡œ
            // ì¤‘ì‹¬ì„ ë§ˆì»¤ë³´ë‹¤ ì•„ë˜ë¡œ ì´ë™ì‹œì¼œì•¼ í•˜ë¯€ë¡œ ìœ„ë„ë¥¼ ì¦ê°€ (ë‚¨ìª½ ì´ë™)
            const bottomRatio = 0.75; // í™”ë©´ í•˜ë‹¨ 1/4 ì§€ì  = í™”ë©´ì˜ 75% ìœ„ì¹˜
            const deltaLat = latRange * (bottomRatio - 0.5); // 0.5ëŠ” ì¤‘ì•™, bottomRatioëŠ” ëª©í‘œ ìœ„ì¹˜
            
            // ê°€ë¡œëŠ” ì¤‘ì•™ ìœ ì§€ (ê²½ë„ëŠ” ê·¸ëŒ€ë¡œ), ì„¸ë¡œëŠ” í•˜ë‹¨ì— ê°€ê¹ê²Œ (ìœ„ë„ ì¦ê°€)
            const newCenter = new naver.maps.LatLng(latlng.lat() + deltaLat, latlng.lng());
            map.panTo(newCenter);
        }

        function createSumClusterIcon(bgColor, textColor) {
            // MarkerClusteringì€ â€œtextâ€ê°€ ë“¤ì–´ê°ˆ ìš”ì†Œë¥¼ `.cluster-text`ë¡œ ì°¾ìŠµë‹ˆë‹¤.
            // ê·¸ë˜ì„œ content ë‚´ë¶€ì— í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤.
            return {
                content: `
                    <div style="
                        width: 64px;
                        height: 64px;
                        border-radius: 50%;
                        background: ${bgColor};
                        border: 4px solid rgba(0,0,0,0.15);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 800;
                        font-size: 18px;
                        color: ${textColor};
                        user-select: none;
                    ">
                        <span class="cluster-text">0</span>
                    </div>
                `,
                size: new naver.maps.Size(64, 64),
                anchor: new naver.maps.Point(32, 32)
            };
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const resultsContainer = document.getElementById('searchResults');
            const registerBtn = document.querySelector('.register-btn');
            
            // ëª¨ë°”ì¼ ì²´í¬ í•¨ìˆ˜
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            // ì‚¬ì¥ë‹˜ ë²„íŠ¼ì„ ë‹¤ì‹œ ë³´ì´ê²Œ í•˜ëŠ” í•¨ìˆ˜
            function showRegisterBtn() {
                if (isMobile() && registerBtn) {
                    registerBtn.style.display = 'flex';
                }
            }
            
            // ì‚¬ì¥ë‹˜ ë²„íŠ¼ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
            function hideRegisterBtn() {
                if (isMobile() && registerBtn) {
                    registerBtn.style.display = 'none';
                }
            }
            
            // ê²€ìƒ‰ ì·¨ì†Œ í•¨ìˆ˜
            function cancelSearch() {
                searchInput.value = '';
                clearSearchResults();
                displayMarkers(stores);
            }
            
            // ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ì˜ì—­ í¬ì»¤ìŠ¤ ì‹œ ì‚¬ì¥ë‹˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            searchInput.addEventListener('focus', () => {
                if (isMobile()) {
                    hideRegisterBtn();
                }
            });
            
            // ê²€ìƒ‰ ì˜ì—­ í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì‚¬ì¥ë‹˜ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
            searchInput.addEventListener('blur', () => {
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ì´ ê°€ëŠ¥í•˜ë„ë¡
                setTimeout(() => {
                    showRegisterBtn();
                }, 200);
            });
            
            // ê²€ìƒ‰ ì˜ì—­ì´ ì•„ë‹Œ ê³³ì„ í´ë¦­í•˜ë©´ ê²€ìƒ‰ ì·¨ì†Œ ë° ì‚¬ì¥ë‹˜ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸° (ëª¨ë°”ì¼ë§Œ)
            document.addEventListener('click', (e) => {
                if (!isMobile() || !registerBtn) return;
                
                // ê²€ìƒ‰ ì˜ì—­ì´ë‚˜ ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ì„ í´ë¦­í•œ ê²½ìš°ëŠ” ì œì™¸
                const searchContainer = document.querySelector('.search-container');
                const isClickInsideSearch = searchContainer && searchContainer.contains(e.target);
                
                if (!isClickInsideSearch) {
                    // ê²€ìƒ‰ ì˜ì—­ ë°–ì„ í´ë¦­í•˜ë©´ ê²€ìƒ‰ ì·¨ì†Œ
                    if (searchInput.value.trim() !== '') {
                        cancelSearch();
                    }
                    // ì‚¬ì¥ë‹˜ ë²„íŠ¼ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë‹¤ì‹œ ë³´ì´ê¸°
                    if (registerBtn.style.display === 'none') {
                        showRegisterBtn();
                    }
                    // í¬ì»¤ìŠ¤ í•´ì œ
                    if (document.activeElement === searchInput) {
                        searchInput.blur();
                    }
                }
            });
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    displayMarkers(stores);
                    clearSearchResults();
                } else {
                    const filtered = stores.filter(store => 
                        (store.subject && store.subject.toLowerCase().includes(searchTerm)) ||
                        (store.address && store.address.toLowerCase().includes(searchTerm)) ||
                        (store.plaintext && store.plaintext.toLowerCase().includes(searchTerm))
                    );
                    
                    displayMarkers(filtered);
                    renderSearchResults(filtered, searchTerm);
                }
            });

            function clearSearchResults() {
                if (!resultsContainer) return;
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
            }

            function renderSearchResults(list, term) {
                if (!resultsContainer) return;
                if (!list || list.length === 0) {
                    clearSearchResults();
                    return;
                }

                const maxItems = 8;
                resultsContainer.innerHTML = '';

                list.slice(0, maxItems).forEach(store => {
                    const number = parseInt(store.number) || 0;
                    
                    // ì¬ê³  ìƒíƒœ ê²°ì •
                    let statusText, statusColor;
                    if (number === 0) {
                        statusText = 'í’ˆì ˆ';
                        statusColor = '#e74c3c';
                    } else if (number < 30) {
                        statusText = 'í’ˆì ˆ ì„ë°•';
                        statusColor = '#f39c12';
                    } else {
                        statusText = 'ì—¬ìœ ';
                        statusColor = '#27ae60';
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="search-result-image">
                            ${store.img ? `<img src="${store.img}" alt="${store.subject || 'ë§¤ì¥'}" />` : '<div class="search-result-placeholder">ğŸª</div>'}
                        </div>
                        <div class="search-result-content">
                            <span class="search-result-title">${highlightMatch(store.subject || 'ë§¤ì¥ëª… ì—†ìŒ', term)}</span>
                            <span class="search-result-address">${highlightMatch(store.address || '', term)}</span>
                        </div>
                        <div class="search-result-status" style="color: ${statusColor};">
                            ${statusText}
                        </div>
                    `;
                    item.onclick = () => {
                        focusStoreOnMap(store);
                        clearSearchResults();
                        searchInput.blur();
                    };
                    resultsContainer.appendChild(item);
                });

                resultsContainer.classList.remove('hidden');
            }

            function highlightMatch(text, term) {
                if (!term) return text;
                const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escaped, 'gi');
                return text.replace(regex, match => `<strong>${match}</strong>`);
            }

            function focusStoreOnMap(store) {
                if (!store.location) return;

                let lat, lng;
                if (typeof store.location === 'string') {
                    const coords = store.location.split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                } else if (store.location.coordinates) {
                    lng = store.location.coordinates[0];
                    lat = store.location.coordinates[1];
                }
                if (!lat || !lng) return;

                const position = new naver.maps.LatLng(lat, lng);
                map.setCenter(position);
                map.setZoom(15);

                // í•´ë‹¹ ë§¤ì¥ì˜ ë§ˆì»¤ ë° ì •ë³´ì°½ ì°¾ê¸° (id ê¸°ì¤€)
                if (store.id && storeMarkerMap[store.id] && storeInfoWindowMap[store.id]) {
                    infoWindows.forEach(iw => iw.close());
                    currentInfoWindow = storeInfoWindowMap[store.id];
                    currentInfoWindow.open(map, storeMarkerMap[store.id]);
                }
            }

            // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸° (ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ë‹«íˆë„ë¡)
            document.addEventListener('click', (e) => {
                if (!resultsContainer) return;
                if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
                    clearSearchResults();
                }
            });
        }

        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        function goToLogin() {
            window.location.href = 'login.html';
        }

        // ë‚´ í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
        function moveToMyLocation() {
            if (!navigator.geolocation) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const btn = document.getElementById('myLocationBtn');
            btn.style.opacity = '0.6';
            btn.style.cursor = 'wait';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const currentLocation = new naver.maps.LatLng(lat, lng);
                    map.setCenter(currentLocation);
                    map.setZoom(15);
                    
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                },
                function(error) {
                    console.error('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
                    alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
    </script>
</body>
</html>
