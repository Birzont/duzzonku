<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - ë‘ë°”ì´ì«€ë“ì¿ í‚¤</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h2>ë‘ì«€ì¿  íŒë§¤ì¹´í˜ ë“±ë¡</h2>
            
            <button class="btn-google" onclick="signInWithGoogle()">
                ğŸ” Googleë¡œ ë¡œê·¸ì¸
            </button>
            
            <div class="divider">ë˜ëŠ”</div>
            
            <div id="alertBox"></div>
            
            <input type="email" id="email" placeholder="ì´ë©”ì¼" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            
            <button class="btn-primary" onclick="signInWithEmail()">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>
            <button class="btn-primary" onclick="signUpWithEmail()">ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…</button>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="index.html" style="color: #666; text-decoration: none; font-size: 14px;">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        </div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboardView" class="dashboard-container" style="display: none;">
        <div class="dashboard-header">
            <h1>ë§¤ì¥ ê´€ë¦¬</h1>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="dashboard-content">
            <div id="dashboardAlert"></div>
            
            <!-- ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬ -->
            <div class="card">
                <h3>ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬</h3>
                <div class="inventory-control">
                    <button onclick="decreaseInventory()">âˆ’</button>
                    <input type="number" id="inventoryNumber" value="0" min="0" onchange="validateInventory()">
                    <button onclick="increaseInventory()">+</button>
                </div>
                <button class="btn-save" onclick="saveInventory()">ì¬ê³  ì €ì¥</button>
            </div>

            <!-- ë§¤ì¥ ì •ë³´ ê´€ë¦¬ -->
            <div class="card">
                <h3>ë§¤ì¥ ì •ë³´</h3>
                
                <div class="form-group">
                    <label>ëŒ€í‘œ ì‚¬ì§„</label>
                    <div class="file-upload" onclick="document.getElementById('mainImage').click()">
                        <input type="file" id="mainImage" accept="image/*" onchange="previewImage(this, 'mainImagePreview')">
                        <p>ğŸ“· í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                        <div id="mainImagePreview" class="file-preview"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì¢Œí‘œ (ìœ„ë„, ê²½ë„)</label>
                    <input type="text" id="location" placeholder="ì˜ˆ: 37.5665, 126.9780">
                    <small style="color: #666;">Google ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ìš°í´ë¦­í•˜ì—¬ ì¢Œí‘œë¥¼ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì£¼ì†Œ</label>
                    <input type="text" id="address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ...">
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì´ë¦„</label>
                    <input type="text" id="subject" placeholder="ë§¤ì¥ ì´ë¦„">
                </div>

                <div class="form-group">
                    <label>í™ë³´ ë¬¸êµ¬</label>
                    <textarea id="plaintext" placeholder="ë§¤ì¥ì— ëŒ€í•œ ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                </div>

                <div class="form-group">
                    <label>ì—°ê²° URL (ì„ íƒ)</label>
                    <input type="url" id="url" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label>ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ì§„</label>
                    <div class="file-upload" onclick="document.getElementById('govImage').click()">
                        <input type="file" id="govImage" accept="image/*" onchange="previewImage(this, 'govImagePreview')">
                        <p>ğŸ“„ í´ë¦­í•˜ì—¬ ì‚¬ì—…ìë“±ë¡ì¦ ì—…ë¡œë“œ</p>
                        <div id="govImagePreview" class="file-preview"></div>
                    </div>
                </div>

                <button class="btn-save" onclick="saveStoreInfo()">ë§¤ì¥ì •ë³´ ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentStoreId = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                await showDashboard();
            }
        });

        // Google ë¡œê·¸ì¸
        async function signInWithGoogle() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                if (error) throw error;
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ì´ë©”ì¼ ë¡œê·¸ì¸
        async function signInWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('loginView', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                await showDashboard();
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ì´ë©”ì¼ íšŒì›ê°€ì…
        async function signUpWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('loginView', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('loginView', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) throw error;

                if (data.user) {
                    showAlert('loginView', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
                }
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentStoreId = null;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('loginView').style.display = 'flex';
        }

        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        async function showDashboard() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            
            // ê¸°ì¡´ ë§¤ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            await loadStoreData();
        }

        // ë§¤ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadStoreData() {
            try {
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error) {
                    console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (error.code === 'PGRST116') {
                        console.log('ê¸°ì¡´ ë§¤ì¥ ì •ë³´ ì—†ìŒ (ì‹ ê·œ ë“±ë¡)');
                    } else {
                        showAlert('dashboardView', `ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                    return;
                }

                if (data) {
                    currentStoreId = data.id;
                    document.getElementById('inventoryNumber').value = data.number || 0;
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('subject').value = data.subject || '';
                    document.getElementById('plaintext').value = data.plaintext || '';
                    document.getElementById('url').value = data.url || '';
                    
                    if (data.img) {
                        document.getElementById('mainImagePreview').innerHTML = `<img src="${data.img}">`;
                    }
                    if (data.gov) {
                        document.getElementById('govImagePreview').innerHTML = `<img src="${data.gov}">`;
                    }
                }
            } catch (error) {
                console.error('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', error);
            }
        }

        // ì¬ê³  ì¦ê°€
        function increaseInventory() {
            const input = document.getElementById('inventoryNumber');
            input.value = parseInt(input.value || 0) + 1;
        }

        // ì¬ê³  ê°ì†Œ
        function decreaseInventory() {
            const input = document.getElementById('inventoryNumber');
            const current = parseInt(input.value || 0);
            if (current > 0) {
                input.value = current - 1;
            }
        }

        // ì¬ê³  ìœ íš¨ì„± ê²€ì‚¬
        function validateInventory() {
            const input = document.getElementById('inventoryNumber');
            const value = parseInt(input.value || 0);
            if (value < 0) {
                input.value = 0;
            }
        }

        // ì¬ê³ ë§Œ ì €ì¥
        async function saveInventory() {
            const number = parseInt(document.getElementById('inventoryNumber').value || 0);

            if (!currentStoreId) {
                showAlert('dashboardView', 'ë¨¼ì € ë§¤ì¥ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('doozonku')
                    .update({ number: number })
                    .eq('id', currentStoreId);

                if (error) throw error;

                showAlert('dashboardView', 'ì¬ê³ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showAlert('dashboardView', 'ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadImage(file, path) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
            const filePath = `${path}/${fileName}`;

            const { data, error } = await supabaseClient.storage
                .from('doozonku-uploads')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                throw new Error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }

            const { data: { publicUrl } } = supabaseClient.storage
                .from('doozonku-uploads')
                .getPublicUrl(filePath);

            return publicUrl;
        }

        // ë§¤ì¥ ì •ë³´ ì €ì¥
        async function saveStoreInfo() {
            const location = document.getElementById('location').value.trim();
            const address = document.getElementById('address').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const plaintext = document.getElementById('plaintext').value.trim();
            const url = document.getElementById('url').value.trim();
            const number = parseInt(document.getElementById('inventoryNumber').value || 0);

            if (!location || !address || !subject) {
                showAlert('dashboardView', 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showAlert('dashboardView', 'ë§¤ì¥ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...', 'info');

                let imgUrl = null;
                let govUrl = null;

                // ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const mainImageFile = document.getElementById('mainImage').files[0];
                if (mainImageFile) {
                    imgUrl = await uploadImage(mainImageFile, 'stores');
                }

                const govImageFile = document.getElementById('govImage').files[0];
                if (govImageFile) {
                    govUrl = await uploadImage(govImageFile, 'documents');
                }

                const storeData = {
                    user_id: currentUser.id,
                    location: location,
                    address: address,
                    subject: subject,
                    plaintext: plaintext,
                    url: url || null,
                    number: number,
                    checked: 'false'
                };

                if (imgUrl) storeData.img = imgUrl;
                if (govUrl) storeData.gov = govUrl;

                let result;
                if (currentStoreId) {
                    // ì—…ë°ì´íŠ¸
                    result = await supabaseClient
                        .from('doozonku')
                        .update(storeData)
                        .eq('id', currentStoreId);
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    result = await supabaseClient
                        .from('doozonku')
                        .insert([storeData])
                        .select();
                    
                    if (result.data && result.data[0]) {
                        currentStoreId = result.data[0].id;
                    }
                }

                if (result.error) throw result.error;

                showAlert('dashboardView', 'ë§¤ì¥ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.', 'success');
            } catch (error) {
                showAlert('dashboardView', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(viewId, message, type) {
            const alertBox = viewId === 'loginView' 
                ? document.getElementById('alertBox')
                : document.getElementById('dashboardAlert');
            
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertBox.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
