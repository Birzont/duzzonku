<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - ë‘ë°”ì´ì«€ë“ì¿ í‚¤</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <a href="index.html" style="display: block; text-align: center;">
                <img src="logo.png" alt="ë‘ì«€ì¿ " class="login-logo">
            </a>
            <h2>ë‘ì«€ì¿  íŒë§¤ì¹´í˜ ë“±ë¡</h2>
            
            <button class="btn-google" onclick="signInWithGoogle()">
                ğŸ” Googleë¡œ ë¡œê·¸ì¸
            </button>
            
            <div class="divider">ë˜ëŠ”</div>
            
            <div id="alertBox"></div>
            
            <input type="email" id="email" placeholder="ì´ë©”ì¼" required>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            
            <button class="btn-primary" onclick="signInWithEmail()">ë¡œê·¸ì¸</button>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="signUpWithEmail(); return false;" style="color: #666; text-decoration: none; font-size: 14px;">ì´ë©”ì¼ë¡œ ì‚¬ì¥ë‹˜ ê³„ì • ë§Œë“¤ê¸°</a>
            </div>
        </div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboardView" class="dashboard-container" style="display: none;">
        <div class="dashboard-header">
            <div class="dashboard-logo-container">
                <a href="index.html">
                    <img src="logo.png" alt="ë‘ì«€ì¿ " class="dashboard-logo">
                </a>
            </div>
            <h1>ë§¤ì¥ ê´€ë¦¬</h1>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="dashboard-content">
            <div id="dashboardAlert"></div>
            
            <!-- ë§¤ì¥ ì—°ê²° ì¹´ë“œ (ë§¤ì¥ ì •ë³´ê°€ ì—†ëŠ” ì‚¬ìš©ìì—ê²Œë§Œ í‘œì‹œ) -->
            <div id="storeConnectCard" class="card store-connect-card" style="display: none;">
                <img src="duzonkus.png" alt="ë‘ì«€ì¿ " style="width: 100%; max-width: 120px; margin: 0 auto 20px; display: block;">
                <h3 style="text-align: center; margin-bottom: 10px; font-size: 22px;">ì´ë¯¸ ì•ˆë‚´ë°›ì€ ë§¤ì¥ì´ ìˆìœ¼ì‹ ê°€ìš”?</h3>
                <p style="text-align: center; color: #999; font-size: 14px; margin-bottom: 20px;">
                    ê´€ë¦¬ì ë˜ëŠ” ì‚¬ì¥ë‹˜ìœ¼ë¡œë¶€í„° ë°›ì€ ë§¤ì¥ ì½”ë“œë¥¼ ì…ë ¥í•´ í¸ì§‘ê¶Œí•œì„ ê°–ìŠµë‹ˆë‹¤
                </p>
                <div class="form-group">
                    <input type="text" id="storeCodeTop" placeholder="ê´€ë¦¬ì ë˜ëŠ” ì‚¬ì¥ë‹˜ì´ ë°œê¸‰í•œ ë§¤ì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="btn-save" onclick="connectStoreFromTop()">ë§¤ì¥ ì—°ê²°</button>
            </div>
            
            <!-- ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬ -->
            <div class="card inventory-card">
                <h3>ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬</h3>
                <div id="inventoryUpdateTime" class="inventory-update-time"></div>
                <div class="inventory-control">
                    <button onclick="decreaseInventory()">âˆ’</button>
                    <input type="number" id="inventoryNumber" value="0" min="0" onchange="validateInventory()">
                    <button onclick="increaseInventory()">+</button>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>í™ë³´ ë¬¸êµ¬</label>
                    <textarea id="plaintextInventory" placeholder="ë§¤ì¥ì— ëŒ€í•œ ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”." oninput="syncPlaintextFromInventory()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 80px;"></textarea>
                </div>
                <button class="btn-save" onclick="saveInventory()">ì¬ê³  ì—…ë°ì´íŠ¸</button>
            </div>

            <!-- ë§¤ì¥ ì •ë³´ ê´€ë¦¬ -->
            <div class="card">
                <h3>ë§¤ì¥ ì •ë³´</h3>
                
                <div class="form-group">
                    <label>ëŒ€í‘œ ì‚¬ì§„</label>
                    <div class="file-upload" onclick="document.getElementById('mainImage').click()">
                        <input type="file" id="mainImage" accept="image/*" onchange="previewImage(this, 'mainImagePreview')">
                        <p>ğŸ“· í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                        <div id="mainImagePreview" class="file-preview"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì¢Œí‘œ (ìœ„ë„, ê²½ë„)</label>
                    <input type="text" id="location" placeholder="ì˜ˆ: 37.5665, 126.9780">
                    <small style="color: #666;">Google ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ìš°í´ë¦­í•˜ì—¬ ì¢Œí‘œë¥¼ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì£¼ì†Œ</label>
                    <input type="text" id="address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ...">
                </div>

                <div class="form-group">
                    <label>ë§¤ì¥ ì´ë¦„</label>
                    <input type="text" id="subject" placeholder="ë§¤ì¥ ì´ë¦„">
                </div>

                <div class="form-group">
                    <label>í™ë³´ ë¬¸êµ¬</label>
                    <textarea id="plaintext" placeholder="ë§¤ì¥ì— ëŒ€í•œ ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”." oninput="syncPlaintext()"></textarea>
                </div>

                <div class="form-group">
                    <label>ì—°ê²° URL (ì„ íƒ)</label>
                    <input type="url" id="url" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label>ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ì§„</label>
                    <div class="file-upload" onclick="document.getElementById('govImage').click()">
                        <input type="file" id="govImage" accept="image/*" onchange="previewImage(this, 'govImagePreview')">
                        <p>ğŸ“„ í´ë¦­í•˜ì—¬ ì‚¬ì—…ìë“±ë¡ì¦ ì—…ë¡œë“œ</p>
                        <div id="govImagePreview" class="file-preview"></div>
                    </div>
                </div>

                <button class="btn-save" onclick="saveStoreInfo()">ë§¤ì¥ì •ë³´ ì €ì¥</button>
            </div>

            <!-- ë¡œê·¸ì¸ ì •ë³´ ê´€ë¦¬ -->
            <div class="card">
                <h3>ë¡œê·¸ì¸ ì •ë³´</h3>
                
                <div class="form-group">
                    <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
                    <input type="email" id="userEmail" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <small style="color: #666;">ì´ë©”ì¼ ì£¼ì†ŒëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
                </div>

                <div id="connectedStoreInfo" class="form-group" style="display: none;">
                    <label>ì—°ê²°ëœ ë§¤ì¥</label>
                    <input type="text" id="connectedStoreName" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <small style="color: #28a745;">âœ“ ë§¤ì¥ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë§¤ì¥ ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>

                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì)">
                </div>

                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="newPasswordConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥">
                </div>

                <button class="btn-save" onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentStoreId = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                await showDashboard();
            }
        });

        // Google ë¡œê·¸ì¸
        async function signInWithGoogle() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                if (error) throw error;
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ì´ë©”ì¼ ë¡œê·¸ì¸
        async function signInWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('loginView', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                await showDashboard();
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ì´ë©”ì¼ íšŒì›ê°€ì…
        async function signUpWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('loginView', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('loginView', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) throw error;

                if (data.user) {
                    showAlert('loginView', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
                }
            } catch (error) {
                showAlert('loginView', error.message, 'error');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentStoreId = null;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('loginView').style.display = 'flex';
        }

        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        async function showDashboard() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            
            // ì´ë©”ì¼ ì£¼ì†Œ í‘œì‹œ
            if (currentUser && currentUser.email) {
                document.getElementById('userEmail').value = currentUser.email;
            }
            
            // ê¸°ì¡´ ë§¤ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            await loadStoreData();
        }

        // ë§¤ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadStoreData() {
            try {
                // user_idë¶€í„° user_id_6ê¹Œì§€ í˜„ì¬ ì‚¬ìš©ìì¸ ë§¤ì¥ ì°¾ê¸°
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .or(`user_id.eq.${currentUser.id},user_id_2.eq.${currentUser.id},user_id_3.eq.${currentUser.id},user_id_4.eq.${currentUser.id},user_id_5.eq.${currentUser.id},user_id_6.eq.${currentUser.id}`)
                    .maybeSingle();

                if (error) {
                    console.error('ë§¤ì¥ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (error.code === 'PGRST116') {
                        console.log('ê¸°ì¡´ ë§¤ì¥ ì •ë³´ ì—†ìŒ (ì‹ ê·œ ë“±ë¡)');
                    } else {
                        showAlert('dashboardView', `ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                    return;
                }

                if (data) {
                    currentStoreId = data.id;
                    document.getElementById('inventoryNumber').value = data.number || 0;
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('subject').value = data.subject || '';
                    document.getElementById('plaintext').value = data.plaintext || '';
                    document.getElementById('plaintextInventory').value = data.plaintext || '';
                    document.getElementById('url').value = data.url || '';
                    
                    // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                    if (data.updated_at) {
                        updateInventoryTime(data.updated_at);
                    }
                    
                    // ì—°ê²°ëœ ë§¤ì¥ ì •ë³´ í‘œì‹œ
                    document.getElementById('storeConnectCard').style.display = 'none';
                    document.getElementById('connectedStoreInfo').style.display = 'block';
                    document.getElementById('connectedStoreName').value = data.subject || 'ì—°ê²°ëœ ë§¤ì¥';
                    
                    if (data.img) {
                        document.getElementById('mainImagePreview').innerHTML = `<img src="${data.img}">`;
                    }
                    if (data.gov) {
                        document.getElementById('govImagePreview').innerHTML = `<img src="${data.gov}">`;
                    }
                } else {
                    // ë§¤ì¥ì´ ì—†ìœ¼ë©´ ìƒë‹¨ ë§¤ì¥ ì—°ê²° ì¹´ë“œ í‘œì‹œ
                    document.getElementById('storeConnectCard').style.display = 'block';
                    document.getElementById('connectedStoreInfo').style.display = 'none';
                }
            } catch (error) {
                console.error('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', error);
            }
        }

        // ì¬ê³  ì¦ê°€
        function increaseInventory() {
            const input = document.getElementById('inventoryNumber');
            input.value = parseInt(input.value || 0) + 1;
        }

        // ì¬ê³  ê°ì†Œ
        function decreaseInventory() {
            const input = document.getElementById('inventoryNumber');
            const current = parseInt(input.value || 0);
            if (current > 0) {
                input.value = current - 1;
            }
        }

        // ì¬ê³  ìœ íš¨ì„± ê²€ì‚¬
        function validateInventory() {
            const input = document.getElementById('inventoryNumber');
            const value = parseInt(input.value || 0);
            if (value < 0) {
                input.value = 0;
            }
        }

        // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (ëª‡ ë¶„/ì‹œê°„/ì¼ ì „)
        function formatTimeAgo(dateString) {
            if (!dateString) return '';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) {
                return 'ë°©ê¸ˆ ì „ ì—…ë°ì´íŠ¸';
            } else if (diffMins < 60) {
                return `${diffMins}ë¶„ ì „ ì—…ë°ì´íŠ¸`;
            } else if (diffHours < 24) {
                return `${diffHours}ì‹œê°„ ì „ ì—…ë°ì´íŠ¸`;
            } else {
                return `${diffDays}ì¼ ì „ ì—…ë°ì´íŠ¸`;
            }
        }

        // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
        function updateInventoryTime(updatedAt) {
            const timeElement = document.getElementById('inventoryUpdateTime');
            if (timeElement && updatedAt) {
                timeElement.textContent = formatTimeAgo(updatedAt);
            } else if (timeElement) {
                timeElement.textContent = '';
            }
        }

        // í™ë³´ ë¬¸êµ¬ ë™ê¸°í™” (ë§¤ì¥ ì •ë³´ì˜ í™ë³´ ë¬¸êµ¬ì™€ ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬ì˜ í™ë³´ ë¬¸êµ¬ ë™ê¸°í™”)
        function syncPlaintext() {
            const plaintextValue = document.getElementById('plaintext').value;
            document.getElementById('plaintextInventory').value = plaintextValue;
        }

        // ì‹¤ì‹œê°„ ì¬ê³  ê´€ë¦¬ì˜ í™ë³´ ë¬¸êµ¬ ë³€ê²½ ì‹œ ë§¤ì¥ ì •ë³´ì˜ í™ë³´ ë¬¸êµ¬ë„ ë™ê¸°í™”
        function syncPlaintextFromInventory() {
            const plaintextValue = document.getElementById('plaintextInventory').value;
            document.getElementById('plaintext').value = plaintextValue;
        }

        // ì¬ê³ ë§Œ ì €ì¥
        async function saveInventory() {
            const number = parseInt(document.getElementById('inventoryNumber').value || 0);
            const plaintext = document.getElementById('plaintextInventory').value.trim();

            if (!currentStoreId) {
                showAlert('dashboardView', 'ë¨¼ì € ë§¤ì¥ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('doozonku')
                    .update({ number: number, plaintext: plaintext })
                    .eq('id', currentStoreId)
                    .select('updated_at')
                    .single();

                if (error) throw error;

                // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                if (data && data.updated_at) {
                    updateInventoryTime(data.updated_at);
                } else {
                    // updated_atì´ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
                    updateInventoryTime(new Date().toISOString());
                }

                showAlert('dashboardView', 'ì¬ê³ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showAlert('dashboardView', 'ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadImage(file, path) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
            const filePath = `${path}/${fileName}`;

            const { data, error } = await supabaseClient.storage
                .from('doozonku-uploads')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                throw new Error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }

            const { data: { publicUrl } } = supabaseClient.storage
                .from('doozonku-uploads')
                .getPublicUrl(filePath);

            return publicUrl;
        }

        // ë§¤ì¥ ì •ë³´ ì €ì¥
        async function saveStoreInfo() {
            const location = document.getElementById('location').value.trim();
            const address = document.getElementById('address').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const plaintext = document.getElementById('plaintext').value.trim();
            const url = document.getElementById('url').value.trim();
            const number = parseInt(document.getElementById('inventoryNumber').value || 0);

            if (!location || !address || !subject) {
                showAlert('dashboardView', 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showAlert('dashboardView', 'ë§¤ì¥ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...', 'info');

                let imgUrl = null;
                let govUrl = null;

                // ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const mainImageFile = document.getElementById('mainImage').files[0];
                if (mainImageFile) {
                    imgUrl = await uploadImage(mainImageFile, 'stores');
                }

                const govImageFile = document.getElementById('govImage').files[0];
                if (govImageFile) {
                    govUrl = await uploadImage(govImageFile, 'documents');
                }

                const storeData = {
                    user_id: currentUser.id,
                    location: location,
                    address: address,
                    subject: subject,
                    plaintext: plaintext,
                    url: url || null,
                    number: number,
                    checked: 'false'
                };

                if (imgUrl) storeData.img = imgUrl;
                if (govUrl) storeData.gov = govUrl;

                let result;
                if (currentStoreId) {
                    // ì—…ë°ì´íŠ¸
                    result = await supabaseClient
                        .from('doozonku')
                        .update(storeData)
                        .eq('id', currentStoreId);
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    result = await supabaseClient
                        .from('doozonku')
                        .insert([storeData])
                        .select();
                    
                    if (result.data && result.data[0]) {
                        currentStoreId = result.data[0].id;
                    }
                }

                if (result.error) throw result.error;

                showAlert('dashboardView', 'ë§¤ì¥ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.', 'success');
            } catch (error) {
                showAlert('dashboardView', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ìƒë‹¨ ì¹´ë“œì—ì„œ ë§¤ì¥ ì½”ë“œë¡œ ë§¤ì¥ ì—°ê²°
        async function connectStoreFromTop() {
            const storeCode = document.getElementById('storeCodeTop').value.trim();
            if (!storeCode) {
                showAlert('dashboardView', 'ë§¤ì¥ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            await connectStore(storeCode, 'storeCodeTop');
        }

        // ë§¤ì¥ ì½”ë“œë¡œ ë§¤ì¥ ì—°ê²°
        async function connectStore(storeCodeInput = null, inputId = null) {
            const storeCode = storeCodeInput || (inputId ? document.getElementById(inputId).value.trim() : '');

            if (!storeCode) {
                showAlert('dashboardView', 'ë§¤ì¥ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!currentUser) {
                showAlert('dashboardView', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                // ë§¤ì¥ ì½”ë“œë¡œ ë§¤ì¥ ì°¾ê¸° (RLS ì •ì±…ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ ì„œë²„ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, 
                // ê´€ë¦¬ìê°€ ë¯¸ë¦¬ ì„¤ì •í•œ ë§¤ì¥ ì½”ë“œë¡œ ì°¾ê¸°)
                // ì¼ë‹¨ ì§ì ‘ ì¡°íšŒ ì‹œë„ (ìŠ¹ì¸ëœ ë§¤ì¥ì€ ëª¨ë‘ ë³¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                const { data: storeData, error: findError } = await supabaseClient
                    .from('doozonku')
                    .select('*')
                    .eq('store_code', storeCode)
                    .maybeSingle();

                if (findError) {
                    throw findError;
                }

                if (!storeData) {
                    showAlert('dashboardView', 'ë§¤ì¥ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                    return;
                }

                // ì´ë¯¸ í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (storeData.user_id === currentUser.id || 
                    storeData.user_id_2 === currentUser.id ||
                    storeData.user_id_3 === currentUser.id ||
                    storeData.user_id_4 === currentUser.id ||
                    storeData.user_id_5 === currentUser.id ||
                    storeData.user_id_6 === currentUser.id) {
                    showAlert('dashboardView', 'ì´ë¯¸ ì´ ë§¤ì¥ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info');
                    await loadStoreData();
                    return;
                }

                // ì´ë¯¸ 6ëª…ì´ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (storeData.user_id && storeData.user_id_2 && storeData.user_id_3 && 
                    storeData.user_id_4 && storeData.user_id_5 && storeData.user_id_6) {
                    showAlert('dashboardView', 'ì´ ë§¤ì¥ì€ ì´ë¯¸ 6ëª…ì˜ ì‚¬ìš©ìì—ê²Œ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 6ëª…)', 'error');
                    return;
                }

                // ë§¤ì¥ì˜ user_idë¶€í„° user_id_6ê¹Œì§€ ë¹ˆ ìë¦¬ì— í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€
                let updateData;
                let updateError;
                let updateField = {};
                
                if (!storeData.user_id) {
                    updateField = { user_id: currentUser.id };
                } else if (!storeData.user_id_2) {
                    updateField = { user_id_2: currentUser.id };
                } else if (!storeData.user_id_3) {
                    updateField = { user_id_3: currentUser.id };
                } else if (!storeData.user_id_4) {
                    updateField = { user_id_4: currentUser.id };
                } else if (!storeData.user_id_5) {
                    updateField = { user_id_5: currentUser.id };
                } else if (!storeData.user_id_6) {
                    updateField = { user_id_6: currentUser.id };
                } else {
                    // ì´ë¯¸ 6ëª…ì´ ì—°ê²°ë˜ì–´ ìˆìŒ (ìœ„ì—ì„œ ì²´í¬í–ˆì§€ë§Œ ì•ˆì „ì¥ì¹˜)
                    showAlert('dashboardView', 'ì´ ë§¤ì¥ì€ ì´ë¯¸ 6ëª…ì˜ ì‚¬ìš©ìì—ê²Œ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 6ëª…)', 'error');
                    return;
                }

                const result = await supabaseClient
                    .from('doozonku')
                    .update(updateField)
                    .eq('store_code', storeCode)
                    .eq('id', storeData.id)
                    .select()
                    .single();
                updateData = result.data;
                updateError = result.error;

                if (updateError) {
                    // RLS ì •ì±… ë•Œë¬¸ì— ì—…ë°ì´íŠ¸ê°€ ì•ˆ ë  ìˆ˜ ìˆìŒ
                    // ì´ ê²½ìš° ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ë„ë¡ ì•ˆë‚´
                    console.error('ë§¤ì¥ ì—°ê²° ì˜¤ë¥˜:', updateError);
                    showAlert('dashboardView', 'ë§¤ì¥ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”. ì˜¤ë¥˜: ' + updateError.message, 'error');
                    return;
                }

                // ì—°ê²° ì„±ê³µ
                currentStoreId = updateData.id;
                showAlert('dashboardView', 'ë§¤ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                if (inputId === 'storeCodeTop') {
                    document.getElementById('storeCodeTop').value = '';
                }
                
                // ë§¤ì¥ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                await loadStoreData();
            } catch (error) {
                console.error('ë§¤ì¥ ì—°ê²° ì˜¤ë¥˜:', error);
                showAlert('dashboardView', 'ë§¤ì¥ ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

            if (!newPassword || !newPasswordConfirm) {
                showAlert('dashboardView', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('dashboardView', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (newPassword !== newPasswordConfirm) {
                showAlert('dashboardView', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('newPassword').value = '';
                document.getElementById('newPasswordConfirm').value = '';

                showAlert('dashboardView', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showAlert('dashboardView', 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(viewId, message, type) {
            const alertBox = viewId === 'loginView' 
                ? document.getElementById('alertBox')
                : document.getElementById('dashboardAlert');
            
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertBox.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
